<script src="jsonstore.js"></script>
<script>
//FIXME: Expire these eventually
var doNotRedirect = [];
var potentialSites = [];

if(!String.prototype.startsWith){
    String.prototype.startsWith = function (str) {
        return !this.indexOf(str);
    }
}

if(!String.prototype.contains) {
	String.prototype.contains = function(it) { 
		return this.indexOf(it) != -1;
	};
}

/**
 * Extracts the protocol and the origin from the given URL.
 */
function ProtoOrigin(url) {
	var p = /^([^:]+):/.exec(url),
		o = /^[^:]+:\/{0,2}([^\/]+)\/?/.exec(url);
	this.p = p[1];
	this.o = o[1];
	this.url = url;
}
ProtoOrigin.prototype = {
	/**
	 * Does the given protocol have a secure version?
	 */
	hasSecure: function() {
		return this.p == 'http';
	},
	
	/**
	 * Is the given URL secure?
	 */
	isSecure: function() {
		return this.p == 'https';
	},
	
	makeSecure: function() {
		return this.url.replace("http://", "https://");
	},
	
	inSitesList: function(sites) {
		if (sites == null) {
			sites = jsonStorage.get('sites');
		}
		return sites.indexOf(this.o) != -1
	}
};

// Initialize stored values
init();

chrome.tabs.onUpdated.addListener(function(tabId, info, tab) {
	
	if(info.status == "loading") {
		
		var isDisabled = jsonStorage.get('is-disabled');
		if (isDisabled) {
			chrome.pageAction.hide(tabId)
			return;
		}
		
		/*
		 * The enablePageAction variable indicates if we show the 
		 * Use HTTPS icon in the address bar via a page action
		 */
		var enablePageAction = jsonStorage.get('enable-page-action');
		
		var po = new ProtoOrigin(tab.url);
		var siteInList = po.inSitesList();
		if(!po.isSecure()) {
			
			if(siteInList) {
			}
			else {
				chrome.pageAction.hide(tabId);
			}
		}
		else if(enablePageAction && po.isSecure()) {
			if(siteInList) {
				chrome.pageAction.show(tabId);
			}
		}
		else {
			
			chrome.pageAction.hide(tabId);
		}
	}
});

function beforeRequest(request) {
	if (!request) return {}; // on handlerBehaviorChanged() 
	
	var isDisabled = jsonStorage.get('is-disabled');
	if (isDisabled) return {};
	
	var po = new ProtoOrigin(request.url);
	if (!po.hasSecure()) return {};
	
	var siteInList = po.inSitesList();
	
	if (!po.isSecure()) {
		if(siteInList) {
			if(doNotRedirect.indexOf(po.o) == -1) {
				var surl = po.makeSecure();
				console.log("Redirecting "+request.url+" to "+surl);
				return {redirectUrl: surl}
			}
			else {
				console.log("Detected circular redirect http --> https --> http --> https --> etc.")
			}
		} else {
			window.setTimeout(function() {
				testUrlForHttps(po.o, function(hasHttps) {
					if (hasHttps) {
						if (potentialSites.indexOf(po.o) == -1) {
							console.log("Potential site: "+po.o);
							potentialSites.push(po.o);
						}
					}
				});
			}, 0);
		}
	}
	return {};
}
chrome.webRequest.onBeforeRequest.addListener(beforeRequest, {urls: ['http://*/*'], types: ['main_frame']}, ["blocking"]);

function beforeRedirect(details) {
	if (!details) return; // on handlerBehaviorChanged() 
	var frompo = new ProtoOrigin(details.url),
	    topo = new ProtoOrigin(details.redirectUrl);
	if (frompo.isSecure() && !topo.isSecure()) {
        console.log("Blacklist: "+frompo.o+" ("+frompo.url+" -> "+topo.url+")"
		var origin = frompo.o;
		doNotRedirect.push(origin);
	}
}
chrome.webRequest.onBeforeRedirect.addListener(beforeRedirect, {urls: ['https://*/*'], types: ['main_frame']});

function redirectChanged() {
	chrome.webRequest.handlerBehaviorChanged(beforeRequest);
	chrome.webRequest.handlerBehaviorChanged(beforeRedirect);
}

function init() {
	jsonStorage.setDefault('sites', ["facebook.com", "twitter.com", "google.com", "wikipedia.org"]); 
	jsonStorage.setDefault('is-disabled', false);
	jsonStorage.setDefault('enable-page-action', false);

	potentialSites = jsonStorage.setDefault('potential-sites', []);
	doNotRedirect = jsonStorage.setDefault('do-not-redirect', []);
}

window.setInterval(function() {
	var newPS = [];
	for (i in potentialSites) {
		if (potentialSites[i] != null && doNotRedirect.indexOf(potentialSites[i]) == -1) {
			newPS.push(potentialSites[i]);
		}
	}
	potentialSites = newPS;
	jsonStorage.set('potential-sites', potentialSites);
	jsonStorage.set('do-not-redirect', doNotRedirect);
}, 1000);

var urlCache = {};
//FIXME: Detect when a duplicate request comes in before the first finishes.
function testUrlForHttps(url, callback) {
	if (urlCache[url] != null) {
		callback(urlCache[url]);
		return;
	}
	var xhr = new XMLHttpRequest();
	xhr.open('GET', 'https://' + url, true);
	
	xhr.onreadystatechange = function(data) {
		
		if (xhr.readyState == 4) {
			
			if (xhr.status == 200) {
				urlCache[url] = true;
				callback(true);
			}
			else {
				urlCache[url] = false;
				callback(false);
			}
		}
	}

	xhr.send();
}

</script>
