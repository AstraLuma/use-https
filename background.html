<script>

if(!String.prototype.startsWith){
    String.prototype.startsWith = function (str) {
        return !this.indexOf(str);
    }
}

if(!String.prototype.contains) {
	String.prototype.contains = function(it) { 
		return this.indexOf(it) != -1;
	};
}

function getProtoOrigin(url) {
	var p = /^([^:]+):/.exec(url),
		o = /^[^:]+:\/\/([^\/]+)\//.exec(url);
	return {p: p[1], o: o[1]};
}

function isSecure(url) {
	return getProtoOrigin(url).p == 'https';
}

function makeSecure(url) {
	return url.replace("http://", "https://");
}

// Initialize stored values
init();

chrome.tabs.onUpdated.addListener(function(tabId, info, tab) {
	
	if(info.status == "loading") {
		
		var isDisabled = localStorage.getItem('is-disabled') == "true";
		if (isDisabled) {
			chrome.pageAction.hide(tabId)
			return;
		}
		
		/*
		 * The enablePageAction variable indicates if we show the 
		 * Use HTTPS icon in the address bar via a page action
		 */
		var enablePageAction = localStorage.getItem('enable-page-action') == "true";
		
		var sites = JSON.parse(localStorage.getItem('sites'));
		var siteInList = sites.indexOf(getProtoOrigin(tab.url).o) != -1;
		if(!isSecure(tab.url)) {
			
			// Getting a list of sites from localStorage
			
			if(siteInList) {
			}
			else {
				chrome.pageAction.hide(tabId);
			}
		}
		else if(enablePageAction && isSecure(tab.url)) {
			if(siteInList) {
				chrome.pageAction.show(tabId);
			}
		}
		else {
			
			chrome.pageAction.hide(tabId);
		}
	}
});


// This array is used to detect circular http to https redirects
var doNotRedirect = [];
var potentialSites = [];
const wrFilters = {urls: ['<all_urls>'], types: ['main_frame']}

function beforeRequest(request) {
	if (!request) return {}; // on handlerBehaviorChanged() 
	
	var isDisabled = localStorage.getItem('is-disabled') == "true";
	if (isDisabled) return {};
	
	var po = getProtoOrigin(request.url);
	if (po.p != 'http') return {};
	
	var sites = JSON.parse(localStorage.getItem('sites'));
	var siteInList = sites.indexOf(po.o) != -1;
	
	if (!isSecure(request.url)) {
		
		// Getting a list of sites from localStorage
		if(siteInList) {
			
			// Detecting if there is a circular http to https request
			if(doNotRedirect.indexOf(po.o) == -1) {
				var surl = makeSecure(request.url);
				console.log("Redirecting "+request.url+" to "+surl);
				return {redirectUrl: surl}
			}
			else {
				console.log("Detected circular redirect http --> https --> http --> https --> etc.")
			}
		} else {
			window.setTimeout(function() {
				testUrlForHttps(po.o, function(hasHttps) {
					if (hasHttps) {
						if (potentialSites.indexOf(po.o) == -1) {
							console.log("Potential site: "+po.o);
							potentialSites.push(po.o);
						}
					} else {
						if (doNotRedirect.indexOf(po.o) == -1) {
							console.log("Blacklist site: "+po.o);
							doNotRedirect.push(po.o);
						}
					}
				});
			}, 0);
		}
	}
	return {};
}
chrome.webRequest.onBeforeRequest.addListener(beforeRequest, wrFilters, ["blocking"]);


function beforeRedirect(details) {
	if (!details) return; // on handlerBehaviorChanged() 
	if (isSecure(details.url) && !isSecure(details.redirectUrl)) {
		var origin = getProtoOrigin(details.url).o;
		doNotRedirect.push(origin);
	}
}
chrome.webRequest.onBeforeRedirect.addListener(beforeRedirect, wrFilters);

function redirectChanged() {
	chrome.webRequest.handlerBehaviorChanged(beforeRequest);
	chrome.webRequest.handlerBehaviorChanged(beforeRedirect);
}

function init() {
	
	// Check if we have stored sites
	var storedSites = localStorage.getItem('sites');

	// IF sites is null, we initialzie it 
	if(null == storedSites) {
		
		var defaultSites = ["facebook.com", "twitter.com", "google.com", "wikipedia.org"];
		localStorage['sites'] = JSON.stringify(defaultSites); 
	}
	
	// Initialize sites enabled flag
	var isDisabled = localStorage.getItem('is-disabled');
	
	if(null == isDisabled) {
		
		localStorage['sites-enabled'] = "false";
	}
	
	// Initizlize enable page action
	var enablePageAction = localStorage.getItem('enable-page-action');
	
	if(null == enablePageAction) {
		
		localStorage['enable-page-action'] = "false";
	}
}

var urlCache = {};

function testUrlForHttps(url, callback) {
	if (urlCache[url] != null) {
		callback(urlCache[url]);
		return;
	}
	var xhr = new XMLHttpRequest();
	xhr.open('GET', 'https://' + url, true);
	
	xhr.onreadystatechange = function(data) {
		
		if (xhr.readyState == 4) {
			
			if (xhr.status == 200) {
				urlCache[url] = true;
				callback(true);
			}
			else {
				urlCache[url] = false;
				callback(false);
			}
		}
	}

	xhr.send();
}

</script>
